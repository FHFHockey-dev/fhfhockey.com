# Tables

## player_totals_unified
```sql
-- Drop & (re)create a COMPREHENSIVE player_totals_unified materialized view
-- that aggregates **every** column from player_stats_unified by (player_id, season_id)

DROP MATERIALIZED VIEW IF EXISTS player_totals_unified CASCADE;

CREATE MATERIALIZED VIEW player_totals_unified AS
WITH base AS (
  -- Pull from the unified per-game view and compute helper numerators/denominators
  SELECT
    psu.player_id,
    psu.season_id,
    psu.team_id,
    psu.player_name,
    psu.position_code,
    psu.shoots_catches,
    psu.date,

    -- raw counts & core numbers
    psu.games_played,
    psu.points,
    psu.goals,
    psu.assists,
    psu.shots,
    psu.plus_minus,
    psu.gw_goals,
    psu.pp_points,
    psu.sh_points,
    psu.penalty_minutes,
    psu.hits,
    psu.blocked_shots,
    psu.takeaways,
    psu.giveaways,

    -- faceoffs (attempt-weighted helpers)
    psu.d_zone_faceoffs,
    psu.ev_faceoffs,
    psu.n_zone_faceoffs,
    psu.o_zone_faceoffs,
    psu.total_faceoffs,
    psu.total_fol,
    psu.total_fow,
    (psu.d_zone_faceoffs::double precision * psu.d_zone_fo_percentage)              AS d_zone_fow_numer,
    (psu.ev_faceoffs::double precision * psu.ev_faceoff_percentage)                 AS ev_fow_numer,
    (psu.n_zone_faceoffs::double precision * psu.n_zone_fo_percentage)              AS n_zone_fow_numer,
    (psu.o_zone_faceoffs::double precision * psu.o_zone_fo_percentage)              AS o_zone_fow_numer,

    -- ES (even-strength) goals for/against
    psu.es_goals_against,
    psu.es_goals_for,

    -- Time on ice (note: in psu, these are per-game or absolute depending on column name)
    psu.toi_per_game,
    psu.es_toi_per_game,
    psu.ev_time_on_ice,
    psu.pp_toi,
    psu.sh_time_on_ice,
    psu.toi_per_game_5v5,

    -- Power play helpers
    psu.pp_assists,
    psu.pp_goals,
    psu.pp_goals_against,
    psu.pp_goals_for,
    psu.pp_individual_sat_for,
    psu.pp_primary_assists,
    psu.pp_secondary_assists,
    psu.pp_shots,
    psu.pp_toi_pct_per_game,
    CASE WHEN psu.pp_toi_pct_per_game IS DISTINCT FROM 0 THEN psu.pp_toi / NULLIF(psu.pp_toi_pct_per_game,0) END AS team_pp_toi_est,

    -- Short-handed helpers
    psu.sh_assists,
    psu.sh_goals,
    psu.sh_primary_assists,
    psu.sh_secondary_assists,
    psu.sh_shots,

    -- 5v5 breakdowns
    psu.assists_5v5,
    psu.goals_5v5,
    psu.points_5v5,
    psu.primary_assists_5v5,
    psu.secondary_assists_5v5,
    psu.total_primary_assists,
    psu.total_secondary_assists,

    -- shifts & misc
    psu.shifts,
    psu.time_on_ice_per_shift,
    psu.missed_shots,

    -- NST all-situations (counts)
    psu.nst_toi,
    psu.nst_first_assists,
    psu.nst_second_assists,
    psu.nst_ixg,
    psu.nst_icf,
    psu.nst_iff,
    psu.nst_iscfs,
    psu.nst_hdcf,
    psu.nst_rush_attempts,
    psu.nst_rebounds_created,
    psu.nst_penalties_drawn,
    psu.nst_hits_taken,
    psu.nst_faceoffs_won,
    psu.nst_faceoffs_lost,

    -- NST on-ice (5v5) counts
    psu.nst_oi_cf,
    psu.nst_oi_ca,
    psu.nst_oi_ff,
    psu.nst_oi_fa,
    psu.nst_oi_sf,
    psu.nst_oi_sa,
    psu.nst_oi_gf,
    psu.nst_oi_ga,
    psu.nst_oi_xgf,
    psu.nst_oi_xga,
    psu.nst_oi_scf,
    psu.nst_oi_sca,
    psu.nst_oi_hdcf,
    psu.nst_oi_hdca,
    psu.nst_oi_hdgf,
    psu.nst_oi_hdga,
    psu.nst_oi_mdcf,
    psu.nst_oi_mdca,
    psu.nst_oi_mdgf,
    psu.nst_oi_mdga,
    psu.nst_oi_ldcf,
    psu.nst_oi_ldca,
    psu.nst_oi_ldgf,
    psu.nst_oi_ldga,
    psu.nst_oi_off_zone_starts,
    psu.nst_oi_neu_zone_starts,
    psu.nst_oi_def_zone_starts,

    -- NST (per-60 & pct) rates in psu – will be aggregated as **time-weighted** unless recomputable
    psu.nst_ipp,
    psu.nst_oi_cf_pct,
    psu.nst_oi_ff_pct,
    psu.nst_oi_sf_pct,
    psu.nst_oi_gf_pct,
    psu.nst_oi_xgf_pct,
    psu.nst_oi_scf_pct,
    psu.nst_oi_hdcf_pct,
    psu.nst_oi_hdgf_pct,
    psu.nst_oi_mdcf_pct,    psu.nst_oi_mdgf_pct,
    psu.nst_oi_shooting_pct,
    psu.nst_oi_save_pct,
    psu.nst_oi_pdo,
    psu.nst_oi_off_zone_start_pct,

    -- NST per-60 (player) – aggregate via counts/time when possible, else TOI-weight
    psu.nst_goals_per_60,
    psu.nst_assists_per_60,
    psu.nst_first_assists_per_60,
    psu.nst_second_assists_per_60,
    psu.nst_points_per_60,
    psu.nst_shots_per_60,
    psu.nst_ixg_per_60,
    psu.nst_icf_per_60,
    psu.nst_iff_per_60,
    psu.nst_iscfs_per_60,
    psu.nst_hdcf_per_60,
    psu.nst_rush_attempts_per_60,
    psu.nst_rebounds_created_per_60,
    psu.nst_pim_per_60,
    psu.nst_penalties_drawn_per_60,
    psu.nst_giveaways_per_60,
    psu.nst_takeaways_per_60,
    psu.nst_hits_per_60,
    psu.nst_shots_blocked_per_60,
    psu.nst_faceoffs_won_per_60,
    psu.nst_faceoffs_lost_per_60,
    psu.nst_hits_taken_per_60,

    -- NST on-ice per-60 (rates) – will recompute from counts when possible
    psu.nst_oi_cf_per_60,
    psu.nst_oi_ca_per_60,
    psu.nst_oi_cf_pct_rates,
    psu.nst_oi_ff_per_60,
    psu.nst_oi_fa_per_60,
    psu.nst_oi_ff_pct_rates,
    psu.nst_oi_sf_per_60,
    psu.nst_oi_sa_per_60,
    psu.nst_oi_sf_pct_rates,
    psu.nst_oi_gf_per_60,
    psu.nst_oi_ga_per_60,
    psu.nst_oi_gf_pct_rates,
    psu.nst_oi_xgf_per_60,
    psu.nst_oi_xga_per_60,
    psu.nst_oi_xgf_pct_rates,
    psu.nst_oi_scf_per_60,
    psu.nst_oi_sca_per_60,
    psu.nst_oi_scf_pct_rates,
    psu.nst_oi_hdcf_per_60,
    psu.nst_oi_hdca_per_60,
    psu.nst_oi_hdcf_pct_rates,
    psu.nst_oi_hdgf_per_60,
    psu.nst_oi_hdga_per_60,
    psu.nst_oi_hdgf_pct_rates,
    psu.nst_oi_mdcf_per_60,
    psu.nst_oi_mdca_per_60,
    psu.nst_oi_mdcf_pct_rates,
    psu.nst_oi_mdgf_per_60,
    psu.nst_oi_mdga_per_60,
    psu.nst_oi_mdgf_pct_rates,
    psu.nst_oi_ldcf_per_60,
    psu.nst_oi_ldca_per_60,
    psu.nst_oi_ldcf_pct_rates,
    psu.nst_oi_ldgf_per_60,
    psu.nst_oi_ldga_per_60,
    psu.nst_oi_ldgf_pct_rates,
    psu.nst_oi_sh_pct_rates,
    psu.nst_oi_sv_pct_rates,
    psu.nst_oi_pdo_rates,
    psu.nst_oi_off_zone_starts_per_60,
    psu.nst_oi_neu_zone_starts_per_60,
    psu.nst_oi_def_zone_starts_per_60,
    psu.nst_oi_off_zone_start_pct_rates,

    -- book-keeping flags & safeties
    psu.has_nst_counts,
    psu.has_nst_counts_oi,
    psu.has_nst_rates,
    psu.has_nst_rates_oi,
    psu.shots_safe,
    psu.shooting_pct_safe,
    psu.possession_pct_safe

  FROM player_stats_unified psu
  WHERE psu.games_played = 1
    AND psu.date >= DATE '2023-01-01'
    AND psu.player_id IS NOT NULL
    AND psu.date IS NOT NULL
)
SELECT
  player_id,
  season_id,
  max(player_name)                    AS player_name,
  array_agg(DISTINCT team_id)         AS team_ids,
  max(position_code)                  AS position_code,
  max(shoots_catches)                 AS shoots_catches,

  -- Core sums
  sum(games_played)                   AS games_played,
  sum(points)                         AS points,
  sum(goals)                          AS goals,
  sum(assists)                        AS assists,
  sum(shots)                          AS shots,
  sum(plus_minus)                     AS plus_minus,
  sum(gw_goals)                       AS gw_goals,
  sum(pp_points)                      AS pp_points,
  sum(sh_points)                      AS sh_points,
  sum(penalty_minutes)                AS penalty_minutes,
  sum(hits)                           AS hits,
  sum(blocked_shots)                  AS blocked_shots,
  sum(takeaways)                      AS takeaways,
  sum(giveaways)                      AS giveaways,

  -- Faceoff totals & % (recomputed from attempts where possible)
  sum(total_faceoffs)                 AS total_faceoffs,
  sum(total_fol)                      AS total_fol,
  sum(total_fow)                      AS total_fow,
  (sum(total_fow)::numeric / NULLIF(sum(total_faceoffs),0))::numeric AS fow_percentage,

  sum(d_zone_faceoffs)                AS d_zone_faceoffs,
  (sum(d_zone_fow_numer)::numeric / NULLIF(sum(d_zone_faceoffs),0))::numeric        AS d_zone_fo_percentage,

  sum(ev_faceoffs)                    AS ev_faceoffs,
  (sum(ev_fow_numer)::numeric / NULLIF(sum(ev_faceoffs),0))::numeric                AS ev_faceoff_percentage,

  sum(n_zone_faceoffs)                AS n_zone_faceoffs,
  (sum(n_zone_fow_numer)::numeric / NULLIF(sum(n_zone_faceoffs),0))::numeric        AS n_zone_fo_percentage,

  sum(o_zone_faceoffs)                AS o_zone_faceoffs,
  (sum(o_zone_fow_numer)::numeric / NULLIF(sum(o_zone_faceoffs),0))::numeric        AS o_zone_fo_percentage,

  -- ES goals for/against & %
  sum(es_goals_for)                   AS es_goals_for,
  sum(es_goals_against)               AS es_goals_against,
  (sum(es_goals_for)::numeric / NULLIF(sum(es_goals_for)+sum(es_goals_against),0))::numeric AS es_goals_for_percentage,

  -- Time on ice aggregations
  sum(toi_per_game)                   AS toi_all_situations,                 -- season total seconds
  (sum(toi_per_game)::numeric / NULLIF(sum(games_played),0))::numeric       AS avg_toi_per_game,
  sum(es_toi_per_game)                AS es_toi_total,                       -- ES season total seconds
  (sum(es_toi_per_game)::numeric / NULLIF(sum(games_played),0))::numeric    AS es_toi_per_game,
  sum(ev_time_on_ice)                 AS ev_time_on_ice,
  sum(pp_toi)                         AS pp_toi,
  sum(sh_time_on_ice)                 AS sh_time_on_ice,
  sum(toi_per_game_5v5)               AS toi_5v5_total,
  (sum(toi_per_game_5v5)::numeric / NULLIF(sum(games_played),0))::numeric   AS toi_per_game_5v5,

  -- Shooting % (all situations)
  (sum(goals)::numeric / NULLIF(sum(shots),0))::numeric                     AS shooting_percentage,

  -- Power play counts & rates
  sum(pp_goals)                       AS pp_goals,
  sum(pp_assists)                     AS pp_assists,
  sum(pp_goals_for)                   AS pp_goals_for,
  sum(pp_goals_against)               AS pp_goals_against,
  sum(pp_points)                      AS pp_points_total,
  sum(pp_primary_assists)             AS pp_primary_assists,
  sum(pp_secondary_assists)           AS pp_secondary_assists,
  sum(pp_individual_sat_for)          AS pp_individual_sat_for,
  sum(pp_shots)                       AS pp_shots,
  (sum(pp_goals)::numeric / NULLIF(sum(pp_shots),0))::numeric               AS pp_shooting_percentage,
  (3600.0 * sum(pp_goals_for))::numeric / NULLIF(sum(pp_toi),0)::numeric    AS pp_goals_for_per_60,
  (3600.0 * sum(pp_goals))::numeric     / NULLIF(sum(pp_toi),0)::numeric    AS pp_goals_per_60,
  (3600.0 * sum(pp_points))::numeric    / NULLIF(sum(pp_toi),0)::numeric    AS pp_points_per_60,
  (3600.0 * sum(pp_primary_assists))::numeric / NULLIF(sum(pp_toi),0)::numeric AS pp_primary_assists_per_60,
  (3600.0 * sum(pp_secondary_assists))::numeric / NULLIF(sum(pp_toi),0)::numeric AS pp_secondary_assists_per_60,
  (3600.0 * sum(pp_individual_sat_for))::numeric / NULLIF(sum(pp_toi),0)::numeric AS pp_individual_sat_per_60,
  (3600.0 * sum(pp_shots))::numeric / NULLIF(sum(pp_toi),0)::numeric        AS pp_shots_per_60,
  (sum(pp_toi)::numeric / NULLIF(sum(team_pp_toi_est),0))::numeric          AS pp_toi_pct_of_team,

  -- Short-handed counts & rates
  sum(sh_goals)                       AS sh_goals,
  sum(sh_assists)                     AS sh_assists,
  sum(sh_primary_assists)             AS sh_primary_assists,
  sum(sh_secondary_assists)           AS sh_secondary_assists,
  sum(sh_shots)                       AS sh_shots,
  (sum(sh_goals)::numeric / NULLIF(sum(sh_shots),0))::numeric               AS sh_shooting_percentage,
  (3600.0 * sum(sh_goals))::numeric / NULLIF(sum(sh_time_on_ice),0)::numeric        AS sh_goals_per_60,
  (3600.0 * sum(sh_primary_assists))::numeric / NULLIF(sum(sh_time_on_ice),0)::numeric AS sh_primary_assists_per_60,
  (3600.0 * sum(sh_secondary_assists))::numeric / NULLIF(sum(sh_time_on_ice),0)::numeric AS sh_secondary_assists_per_60,

  -- 5v5 production & rates
  sum(assists_5v5)                    AS assists_5v5,
  sum(goals_5v5)                      AS goals_5v5,
  sum(points_5v5)                     AS points_5v5,
  sum(primary_assists_5v5)            AS primary_assists_5v5,
  sum(secondary_assists_5v5)          AS secondary_assists_5v5,
  (3600.0 * sum(goals_5v5))::double precision    / NULLIF(sum(toi_per_game_5v5),0)::double precision    AS goals_per_60_5v5,
  (3600.0 * sum(assists_5v5))::double precision  / NULLIF(sum(toi_per_game_5v5),0)::double precision    AS assists_per_60_5v5,
  (3600.0 * sum(points_5v5))::double precision   / NULLIF(sum(toi_per_game_5v5),0)::double precision    AS points_per_60_5v5,

  -- Totals of primary/secondary across all strengths
  sum(total_primary_assists)          AS total_primary_assists,
  sum(total_secondary_assists)        AS total_secondary_assists,

  -- Shifts & misc
  sum(shifts)                         AS shifts,
  (sum(toi_per_game)::numeric / NULLIF(sum(shifts),0))::numeric             AS time_on_ice_per_shift,
  sum(missed_shots)                   AS missed_shots,

  -- NST All-situations totals & derived per-60
  sum(nst_toi)                        AS nst_toi,
  sum(nst_first_assists)              AS nst_first_assists,
  sum(nst_second_assists)             AS nst_second_assists,
  sum(nst_ixg)                        AS nst_ixg,
  sum(nst_icf)                        AS nst_icf,
  sum(nst_iff)                        AS nst_iff,
  sum(nst_iscfs)                      AS nst_iscfs,
  sum(nst_hdcf)                       AS nst_hdcf,
  sum(nst_rush_attempts)              AS nst_rush_attempts,
  sum(nst_rebounds_created)           AS nst_rebounds_created,
  sum(nst_penalties_drawn)            AS nst_penalties_drawn,
  sum(nst_hits_taken)                 AS nst_hits_taken,
  sum(nst_faceoffs_won)               AS nst_faceoffs_won,
  sum(nst_faceoffs_lost)              AS nst_faceoffs_lost,

  (3600.0 * sum(goals))::numeric / NULLIF(sum(nst_toi),0)::numeric          AS nst_goals_per_60,   -- proxy
  (3600.0 * (sum(nst_first_assists)+sum(nst_second_assists)))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_assists_per_60,
  (3600.0 * sum(nst_first_assists))::numeric / NULLIF(sum(nst_toi),0)::numeric   AS nst_first_assists_per_60,
  (3600.0 * sum(nst_second_assists))::numeric / NULLIF(sum(nst_toi),0)::numeric  AS nst_second_assists_per_60,
  (3600.0 * (sum(goals)+sum(nst_first_assists)+sum(nst_second_assists)))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_points_per_60,
  (3600.0 * sum(shots))::numeric / NULLIF(sum(nst_toi),0)::numeric          AS nst_shots_per_60,
  (3600.0 * sum(nst_ixg))::double precision / NULLIF(sum(nst_toi),0)::double precision AS nst_ixg_per_60,
  (3600.0 * sum(nst_icf))::numeric / NULLIF(sum(nst_toi),0)::numeric        AS nst_icf_per_60,
  (3600.0 * sum(nst_iff))::numeric / NULLIF(sum(nst_toi),0)::numeric        AS nst_iff_per_60,
  (3600.0 * sum(nst_iscfs))::numeric / NULLIF(sum(nst_toi),0)::numeric      AS nst_iscfs_per_60,
  (3600.0 * sum(nst_hdcf))::numeric / NULLIF(sum(nst_toi),0)::numeric       AS nst_hdcf_per_60,
  (3600.0 * sum(nst_rush_attempts))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_rush_attempts_per_60,
  (3600.0 * sum(nst_rebounds_created))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_rebounds_created_per_60,
  (3600.0 * sum(penalty_minutes))::numeric / NULLIF(sum(nst_toi),0)::numeric     AS nst_pim_per_60,
  (3600.0 * sum(nst_penalties_drawn))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_penalties_drawn_per_60,
  (3600.0 * sum(giveaways))::numeric / NULLIF(sum(nst_toi),0)::numeric      AS nst_giveaways_per_60,
  (3600.0 * sum(takeaways))::numeric / NULLIF(sum(nst_toi),0)::numeric      AS nst_takeaways_per_60,
  (3600.0 * sum(hits))::numeric / NULLIF(sum(nst_toi),0)::numeric           AS nst_hits_per_60,
  (3600.0 * sum(blocked_shots))::numeric / NULLIF(sum(nst_toi),0)::numeric  AS nst_shots_blocked_per_60,
  (3600.0 * sum(nst_faceoffs_won))::numeric / NULLIF(sum(nst_toi),0)::numeric   AS nst_faceoffs_won_per_60,
  (3600.0 * sum(nst_faceoffs_lost))::numeric / NULLIF(sum(nst_toi),0)::numeric  AS nst_faceoffs_lost_per_60,
  (3600.0 * sum(nst_hits_taken))::numeric / NULLIF(sum(nst_toi),0)::numeric AS nst_hits_taken_per_60,

  -- NST On-ice (5v5) counts & derived share/%
  sum(nst_oi_cf)                      AS nst_oi_cf,
  sum(nst_oi_ca)                      AS nst_oi_ca,
  sum(nst_oi_ff)                      AS nst_oi_ff,
  sum(nst_oi_fa)                      AS nst_oi_fa,
  sum(nst_oi_sf)                      AS nst_oi_sf,
  sum(nst_oi_sa)                      AS nst_oi_sa,
  sum(nst_oi_gf)                      AS nst_oi_gf,
  sum(nst_oi_ga)                      AS nst_oi_ga,
  sum(nst_oi_xgf)                     AS nst_oi_xgf,
  sum(nst_oi_xga)                     AS nst_oi_xga,
  sum(nst_oi_scf)                     AS nst_oi_scf,
  sum(nst_oi_sca)                     AS nst_oi_sca,
  sum(nst_oi_hdcf)                    AS nst_oi_hdcf,
  sum(nst_oi_hdca)                    AS nst_oi_hdca,
  sum(nst_oi_hdgf)                    AS nst_oi_hdgf,
  sum(nst_oi_hdga)                    AS nst_oi_hdga,
  sum(nst_oi_mdcf)                    AS nst_oi_mdcf,
  sum(nst_oi_mdca)                    AS nst_oi_mdca,
  sum(nst_oi_mdgf)                    AS nst_oi_mdgf,
  sum(nst_oi_mdga)                    AS nst_oi_mdga,
  sum(nst_oi_ldcf)                    AS nst_oi_ldcf,
  sum(nst_oi_ldca)                    AS nst_oi_ldca,
  sum(nst_oi_ldgf)                    AS nst_oi_ldgf,
  sum(nst_oi_ldga)                    AS nst_oi_ldga,
  sum(nst_oi_off_zone_starts)         AS nst_oi_off_zone_starts,
  sum(nst_oi_neu_zone_starts)         AS nst_oi_neu_zone_starts,
  sum(nst_oi_def_zone_starts)         AS nst_oi_def_zone_starts,

  -- 5v5 on-ice share metrics (recomputed)
  (sum(nst_oi_cf)::numeric   / NULLIF(sum(nst_oi_cf)+sum(nst_oi_ca),0))::numeric   AS nst_oi_cf_pct,
  (sum(nst_oi_ff)::numeric   / NULLIF(sum(nst_oi_ff)+sum(nst_oi_fa),0))::numeric   AS nst_oi_ff_pct,
  (sum(nst_oi_sf)::numeric   / NULLIF(sum(nst_oi_sf)+sum(nst_oi_sa),0))::numeric   AS nst_oi_sf_pct,
  (sum(nst_oi_gf)::numeric   / NULLIF(sum(nst_oi_gf)+sum(nst_oi_ga),0))::numeric   AS nst_oi_gf_pct,
  (sum(nst_oi_xgf)::double precision / NULLIF(sum(nst_oi_xgf)+sum(nst_oi_xga),0)::double precision)     AS nst_oi_xgf_pct,
  (sum(nst_oi_scf)::numeric  / NULLIF(sum(nst_oi_scf)+sum(nst_oi_sca),0))::numeric AS nst_oi_scf_pct,
  (sum(nst_oi_hdcf)::numeric / NULLIF(sum(nst_oi_hdcf)+sum(nst_oi_hdca),0))::numeric AS nst_oi_hdcf_pct,
  (sum(nst_oi_hdgf)::double precision / NULLIF(sum(nst_oi_hdgf)::double precision + sum(nst_oi_hdga),0)::double precision) AS nst_oi_hdgf_pct,
  (sum(nst_oi_mdcf)::numeric / NULLIF(sum(nst_oi_mdcf)+sum(nst_oi_mdca),0))::numeric AS nst_oi_mdcf_pct,
  (sum(nst_oi_mdgf)::numeric / NULLIF(sum(nst_oi_mdgf)+sum(nst_oi_mdga),0))::numeric AS nst_oi_mdgf_pct,
  (sum(nst_oi_ldcf)::numeric / NULLIF(sum(nst_oi_ldcf)+sum(nst_oi_ldca),0))::numeric AS nst_oi_ldcf_pct,
  (sum(nst_oi_ldgf)::numeric / NULLIF(sum(nst_oi_ldgf)+sum(nst_oi_ldga),0))::numeric AS nst_oi_ldgf_pct,
  (sum(nst_oi_gf)::numeric / NULLIF(sum(nst_oi_sf),0))::numeric                   AS nst_oi_shooting_pct,
  ((sum(nst_oi_sa)-sum(nst_oi_ga))::numeric / NULLIF(sum(nst_oi_sa),0))::numeric   AS nst_oi_save_pct,
  ((sum(nst_oi_gf)::numeric / NULLIF(sum(nst_oi_sf),0)) + ((sum(nst_oi_sa)-sum(nst_oi_ga))::numeric / NULLIF(sum(nst_oi_sa),0)))::numeric AS nst_oi_pdo,
  (sum(nst_oi_off_zone_starts)::numeric / NULLIF(sum(nst_oi_off_zone_starts)+sum(nst_oi_def_zone_starts),0))::numeric AS nst_oi_off_zone_start_pct,

  -- NST on-ice per-60 (recomputed from counts using 5v5 TOI proxy = ev_time_on_ice)
  (3600.0 * sum(nst_oi_cf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_cf_per_60,
  (3600.0 * sum(nst_oi_ca))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_ca_per_60,
  (3600.0 * sum(nst_oi_ff))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_ff_per_60,
  (3600.0 * sum(nst_oi_fa))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_fa_per_60,
  (3600.0 * sum(nst_oi_sf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_sf_per_60,
  (3600.0 * sum(nst_oi_sa))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_sa_per_60,
  (3600.0 * sum(nst_oi_gf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_gf_per_60,
  (3600.0 * sum(nst_oi_ga))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric      AS nst_oi_ga_per_60,
  (3600.0 * sum(nst_oi_xgf))::double precision / NULLIF(sum(ev_time_on_ice),0)::double precision AS nst_oi_xgf_per_60,
  (3600.0 * sum(nst_oi_xga))::double precision / NULLIF(sum(ev_time_on_ice),0)::double precision AS nst_oi_xga_per_60,
  (3600.0 * sum(nst_oi_scf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric     AS nst_oi_scf_per_60,
  (3600.0 * sum(nst_oi_sca))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric     AS nst_oi_sca_per_60,
  (3600.0 * sum(nst_oi_hdcf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_hdcf_per_60,
  (3600.0 * sum(nst_oi_hdca))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_hdca_per_60,
  (3600.0 * sum(nst_oi_hdgf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_hdgf_per_60,
  (3600.0 * sum(nst_oi_hdga))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_hdga_per_60,
  (3600.0 * sum(nst_oi_mdcf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_mdcf_per_60,
  (3600.0 * sum(nst_oi_mdca))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_mdca_per_60,
  (3600.0 * sum(nst_oi_mdgf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_mdgf_per_60,
  (3600.0 * sum(nst_oi_mdga))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_mdga_per_60,
  (3600.0 * sum(nst_oi_ldcf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_ldcf_per_60,
  (3600.0 * sum(nst_oi_ldca))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_ldca_per_60,
  (3600.0 * sum(nst_oi_ldgf))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_ldgf_per_60,
  (3600.0 * sum(nst_oi_ldga))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric    AS nst_oi_ldga_per_60,
  (3600.0 * sum(nst_oi_off_zone_starts))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric AS nst_oi_off_zone_starts_per_60,
  (3600.0 * sum(nst_oi_neu_zone_starts))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric AS nst_oi_neu_zone_starts_per_60,
  (3600.0 * sum(nst_oi_def_zone_starts))::numeric / NULLIF(sum(ev_time_on_ice),0)::numeric AS nst_oi_def_zone_starts_per_60,

  -- Misc % from original view that lack explicit numerators: compute reasonable season aggregates
  (sum(goals)::numeric / NULLIF(sum(points),0))::numeric      AS goals_pct,                 -- share of points that are goals
  (sum(toi_per_game_5v5)::numeric / NULLIF(sum(toi_per_game),0))::numeric AS zone_start_pct, -- proxy; original lacks raw counts
  (sum(toi_per_game_5v5)::numeric / NULLIF(sum(toi_per_game),0))::numeric AS zone_start_pct_5v5, -- proxy
  (sum(shots)::numeric / NULLIF(sum(nst_icf),0))::numeric     AS individual_shots_for_per_60_proxy_ratio,

  -- Safe/flags
  bool_or(has_nst_counts)             AS has_nst_counts,
  bool_or(has_nst_counts_oi)          AS has_nst_counts_oi,
  bool_or(has_nst_rates)              AS has_nst_rates,
  bool_or(has_nst_rates_oi)           AS has_nst_rates_oi,

  -- Convenience safeties aggregated
  sum(shots_safe)                     AS shots_safe_total,
  (sum(goals)::numeric / NULLIF(sum(shots_safe),0))::numeric  AS shooting_pct_safe_agg,
  (sum(nst_oi_cf)::numeric / NULLIF(sum(nst_oi_cf)+sum(nst_oi_ca),0))::numeric AS possession_pct_safe_agg,

  CURRENT_TIMESTAMP                   AS materialized_at
FROM base
GROUP BY player_id, season_id
WITH NO DATA;

-- NOTE:
-- 1) You can REFRESH the materialized view after creation:
--    REFRESH MATERIALIZED VIEW CONCURRENTLY player_totals_unified;
-- 2) This definition intentionally recomputes percentages/rates using correct denominators
--    (shots, faceoffs, TOI, on-ice events), ensuring fields like `pp_shots` are explicitly SUM()'d
--    and used to derive `pp_shooting_percentage` and `pp_shots_per_60`.
```

## player_stats_unified

```sql
 SELECT w.player_id,
    w.date,
    w.season_id,
    p.team_id,
    w.player_name,
    w.position_code,
    w.shoots_catches,
    w.games_played,
    w.points,
    w.goals,
    w.assists,
    w.shots,
    w.shooting_percentage,
    w.plus_minus,
    w.gw_goals,
    w.pp_points,
    w.sh_points,
    w.fow_percentage,
    w.toi_per_game,
    w.penalty_minutes,
    w.hits,
    w.blocked_shots,
    w.takeaways,
    w.giveaways,
    w.d_zone_fo_percentage,
    w.d_zone_faceoffs,
    w.ev_faceoff_percentage,
    w.ev_faceoffs,
    w.n_zone_fo_percentage,
    w.n_zone_faceoffs,
    w.o_zone_fo_percentage,
    w.o_zone_faceoffs,
    w.total_faceoffs,
    w.total_fol,
    w.total_fow,
    w.es_goals_against,
    w.es_goals_for,
    w.es_goals_for_percentage,
    w.es_toi_per_game,
    w.pp_assists,
    w.pp_goals,
    w.pp_goals_against,
    w.pp_goals_for,
    w.pp_goals_for_per_60,
    w.pp_goals_per_60,
    w.pp_individual_sat_for,
    w.pp_individual_sat_per_60,
    w.pp_points_per_60,
    w.pp_primary_assists,
    w.pp_primary_assists_per_60,
    w.pp_secondary_assists,
    w.pp_secondary_assists_per_60,
    w.pp_shooting_percentage,
    w.pp_shots,
    w.pp_shots_per_60,
    w.pp_toi,
    w.pp_toi_pct_per_game,
    w.sh_assists,
    w.sh_goals,
    w.sh_goals_per_60,
    w.sh_primary_assists,
    w.sh_primary_assists_per_60,
    w.sh_secondary_assists,
    w.sh_secondary_assists_per_60,
    w.sh_shooting_percentage,
    w.sh_shots,
    w.sh_time_on_ice,
    w.penalties,
    w.penalties_drawn,
    w.goals_pct,
    w.faceoff_pct_5v5,
    w.individual_sat_for_per_60,
    w.individual_shots_for_per_60,
    w.on_ice_shooting_pct,
    w.sat_pct,
    w.toi_per_game_5v5,
    w.zone_start_pct,
    w.shooting_percentage_5v5,
    w.skater_save_pct_5v5,
    w.skater_shooting_plus_save_pct_5v5,
    w.zone_start_pct_5v5,
    w.assists_5v5,
    w.assists_per_60_5v5,
    w.goals_5v5,
    w.goals_per_60_5v5,
    w.o_zone_start_pct_5v5,
    w.on_ice_shooting_pct_5v5,
    w.points_5v5,
    w.points_per_60_5v5,
    w.primary_assists_5v5,
    w.primary_assists_per_60_5v5,
    w.secondary_assists_5v5,
    w.secondary_assists_per_60_5v5,
    w.total_primary_assists,
    w.total_secondary_assists,
    w.ev_time_on_ice,
    w.shifts,
    w.time_on_ice_per_shift,
    w.missed_shots,
    nc.toi AS nst_toi,
    nc.first_assists AS nst_first_assists,
    nc.second_assists AS nst_second_assists,
    nc.ipp AS nst_ipp,
    nc.ixg AS nst_ixg,
    nc.icf AS nst_icf,
    nc.iff AS nst_iff,
    nc.iscfs AS nst_iscfs,
    nc.hdcf AS nst_hdcf,
    nc.rush_attempts AS nst_rush_attempts,
    nc.rebounds_created AS nst_rebounds_created,
    nc.penalties_drawn AS nst_penalties_drawn,
    nc.hits_taken AS nst_hits_taken,
    nc.faceoffs_won AS nst_faceoffs_won,
    nc.faceoffs_lost AS nst_faceoffs_lost,
    nco.cf AS nst_oi_cf,
    nco.ca AS nst_oi_ca,
    nco.cf_pct AS nst_oi_cf_pct,
    nco.ff AS nst_oi_ff,
    nco.fa AS nst_oi_fa,
    nco.ff_pct AS nst_oi_ff_pct,
    nco.sf AS nst_oi_sf,
    nco.sa AS nst_oi_sa,
    nco.sf_pct AS nst_oi_sf_pct,
    nco.gf AS nst_oi_gf,
    nco.ga AS nst_oi_ga,
    nco.gf_pct AS nst_oi_gf_pct,
    nco.xgf AS nst_oi_xgf,
    nco.xga AS nst_oi_xga,
    nco.xgf_pct AS nst_oi_xgf_pct,
    nco.scf AS nst_oi_scf,
    nco.sca AS nst_oi_sca,
    nco.scf_pct AS nst_oi_scf_pct,
    nco.hdcf AS nst_oi_hdcf,
    nco.hdca AS nst_oi_hdca,
    nco.hdcf_pct AS nst_oi_hdcf_pct,
    nco.hdgf AS nst_oi_hdgf,
    nco.hdga AS nst_oi_hdga,
    nco.hdgf_pct AS nst_oi_hdgf_pct,
    nco.mdcf AS nst_oi_mdcf,
    nco.mdca AS nst_oi_mdca,
    nco.mdcf_pct AS nst_oi_mdcf_pct,
    nco.mdgf AS nst_oi_mdgf,
    nco.mdga AS nst_oi_mdga,
    nco.mdgf_pct AS nst_oi_mdgf_pct,
    nco.ldcf AS nst_oi_ldcf,
    nco.ldca AS nst_oi_ldca,
    nco.ldgf AS nst_oi_ldgf,
    nco.ldga AS nst_oi_ldga,
    nco.on_ice_sh_pct AS nst_oi_shooting_pct,
    nco.on_ice_sv_pct AS nst_oi_save_pct,
    nco.pdo AS nst_oi_pdo,
    nco.off_zone_starts AS nst_oi_off_zone_starts,
    nco.neu_zone_starts AS nst_oi_neu_zone_starts,
    nco.def_zone_starts AS nst_oi_def_zone_starts,
    nco.off_zone_start_pct AS nst_oi_off_zone_start_pct,
    nr.goals_per_60 AS nst_goals_per_60,
    nr.total_assists_per_60 AS nst_assists_per_60,
    nr.first_assists_per_60 AS nst_first_assists_per_60,
    nr.second_assists_per_60 AS nst_second_assists_per_60,
    nr.total_points_per_60 AS nst_points_per_60,
    nr.shots_per_60 AS nst_shots_per_60,
    nr.ixg_per_60 AS nst_ixg_per_60,
    nr.icf_per_60 AS nst_icf_per_60,
    nr.iff_per_60 AS nst_iff_per_60,
    nr.iscfs_per_60 AS nst_iscfs_per_60,
    nr.hdcf_per_60 AS nst_hdcf_per_60,
    nr.rush_attempts_per_60 AS nst_rush_attempts_per_60,
    nr.rebounds_created_per_60 AS nst_rebounds_created_per_60,
    nr.pim_per_60 AS nst_pim_per_60,
    nr.penalties_drawn_per_60 AS nst_penalties_drawn_per_60,
    nr.giveaways_per_60 AS nst_giveaways_per_60,
    nr.takeaways_per_60 AS nst_takeaways_per_60,
    nr.hits_per_60 AS nst_hits_per_60,
    nr.shots_blocked_per_60 AS nst_shots_blocked_per_60,
    nr.faceoffs_won_per_60 AS nst_faceoffs_won_per_60,
    nr.faceoffs_lost_per_60 AS nst_faceoffs_lost_per_60,
    nr.hits_taken_per_60 AS nst_hits_taken_per_60,
    nro.cf_per_60 AS nst_oi_cf_per_60,
    nro.ca_per_60 AS nst_oi_ca_per_60,
    nro.cf_pct AS nst_oi_cf_pct_rates,
    nro.ff_per_60 AS nst_oi_ff_per_60,
    nro.fa_per_60 AS nst_oi_fa_per_60,
    nro.ff_pct AS nst_oi_ff_pct_rates,
    nro.sf_per_60 AS nst_oi_sf_per_60,
    nro.sa_per_60 AS nst_oi_sa_per_60,
    nro.sf_pct AS nst_oi_sf_pct_rates,
    nro.gf_per_60 AS nst_oi_gf_per_60,
    nro.ga_per_60 AS nst_oi_ga_per_60,
    nro.gf_pct AS nst_oi_gf_pct_rates,
    nro.xgf_per_60 AS nst_oi_xgf_per_60,
    nro.xga_per_60 AS nst_oi_xga_per_60,
    nro.xgf_pct AS nst_oi_xgf_pct_rates,
    nro.scf_per_60 AS nst_oi_scf_per_60,
    nro.sca_per_60 AS nst_oi_sca_per_60,
    nro.scf_pct AS nst_oi_scf_pct_rates,
    nro.hdcf_per_60 AS nst_oi_hdcf_per_60,
    nro.hdca_per_60 AS nst_oi_hdca_per_60,
    nro.hdcf_pct AS nst_oi_hdcf_pct_rates,
    nro.hdgf_per_60 AS nst_oi_hdgf_per_60,
    nro.hdga_per_60 AS nst_oi_hdga_per_60,
    nro.hdgf_pct AS nst_oi_hdgf_pct_rates,
    nro.mdcf_per_60 AS nst_oi_mdcf_per_60,
    nro.mdca_per_60 AS nst_oi_mdca_per_60,
    nro.mdcf_pct AS nst_oi_mdcf_pct_rates,
    nro.mdgf_per_60 AS nst_oi_mdgf_per_60,
    nro.mdga_per_60 AS nst_oi_mdga_per_60,
    nro.mdgf_pct AS nst_oi_mdgf_pct_rates,
    nro.ldcf_per_60 AS nst_oi_ldcf_per_60,
    nro.ldca_per_60 AS nst_oi_ldca_per_60,
    nro.ldcf_pct AS nst_oi_ldcf_pct_rates,
    nro.ldgf_per_60 AS nst_oi_ldgf_per_60,
    nro.ldga_per_60 AS nst_oi_ldga_per_60,
    nro.ldgf_pct AS nst_oi_ldgf_pct_rates,
    nro.on_ice_sh_pct AS nst_oi_sh_pct_rates,
    nro.on_ice_sv_pct AS nst_oi_sv_pct_rates,
    nro.pdo AS nst_oi_pdo_rates,
    nro.off_zone_starts_per_60 AS nst_oi_off_zone_starts_per_60,
    nro.neu_zone_starts_per_60 AS nst_oi_neu_zone_starts_per_60,
    nro.def_zone_starts_per_60 AS nst_oi_def_zone_starts_per_60,
    nro.off_zone_start_pct AS nst_oi_off_zone_start_pct_rates,
        CASE
            WHEN nc.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_counts,
        CASE
            WHEN nco.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_counts_oi,
        CASE
            WHEN nr.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_rates,
        CASE
            WHEN nro.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_rates_oi,
    COALESCE(w.shots, 0) AS shots_safe,
    COALESCE(w.shooting_percentage, 0::double precision) AS shooting_pct_safe,
    COALESCE(nco.cf_pct, 0.5::double precision) AS possession_pct_safe,
    CURRENT_TIMESTAMP AS materialized_at
   FROM wgo_skater_stats w
     LEFT JOIN players p ON w.player_id = p.id
     LEFT JOIN nst_gamelog_as_counts nc ON w.player_id = nc.player_id AND w.date = nc.date_scraped AND w.season_id = nc.season
     LEFT JOIN nst_gamelog_as_counts_oi nco ON w.player_id = nco.player_id AND w.date = nco.date_scraped AND w.season_id = nco.season
     LEFT JOIN nst_gamelog_as_rates nr ON w.player_id = nr.player_id AND w.date = nr.date_scraped AND w.season_id = nr.season
     LEFT JOIN nst_gamelog_as_rates_oi nro ON w.player_id = nro.player_id AND w.date = nro.date_scraped AND w.season_id = nro.season
  WHERE w.games_played = 1 AND w.date >= '2023-01-01'::date AND w.player_id IS NOT NULL AND w.date IS NOT NULL
  ORDER BY w.player_id, w.date;
```

### team_games (VIEW)
```sql
 SELECT games.id AS game_id,
    games.date,
    games."homeTeamId" AS team_id,
    games."awayTeamId" AS opponent_team_id,
    true AS is_home
   FROM games
UNION ALL
 SELECT games.id AS game_id,
    games.date,
    games."awayTeamId" AS team_id,
    games."homeTeamId" AS opponent_team_id,
    false AS is_home
   FROM games;
```

## player_baselines
```sql
create table public.player_baselines (
  player_id integer not null,
  season_id integer null,
  snapshot_date date not null,
  position_code text null,
  player_name text null,
  win_l3 jsonb null,
  win_l5 jsonb null,
  win_l10 jsonb null,
  win_l20 jsonb null,
  win_season_prev jsonb null,
  win_3yr jsonb null,
  win_career jsonb null,
  pp_share_sm numeric null,
  pp_share_ref numeric null,
  pp_share_delta numeric null,
  pp_share_rel numeric null,
  pp1_flag boolean null,
  band_widen_factor numeric null,
  computed_at timestamp with time zone null default now(),
  constraint player_baselines_pkey primary key (player_id, snapshot_date)
) TABLESPACE pg_default;
```