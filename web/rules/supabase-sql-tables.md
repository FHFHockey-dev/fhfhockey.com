wgo_skater_stats_totals table:
```sql
create table public.wgo_skater_stats_totals (
  player_id integer not null,
  player_name text null,
  season text not null,
  shoots_catches text null,
  position_code text null,
  games_played integer null,
  points integer null,
  points_per_game double precision null,
  goals integer null,
  assists integer null,
  shots integer null,
  shooting_percentage double precision null,
  plus_minus integer null,
  ot_goals integer null,
  gw_goals integer null,
  pp_points integer null,
  fow_percentage double precision null,
  toi_per_game double precision null,
  blocked_shots integer null,
  blocks_per_60 double precision null,
  empty_net_goals integer null,
  empty_net_points integer null,
  giveaways integer null,
  giveaways_per_60 double precision null,
  hits integer null,
  hits_per_60 double precision null,
  missed_shots integer null,
  takeaways integer null,
  takeaways_per_60 double precision null,
  d_zone_fo_percentage double precision null,
  d_zone_faceoffs integer null,
  ev_faceoff_percentage double precision null,
  ev_faceoffs integer null,
  n_zone_fo_percentage double precision null,
  n_zone_faceoffs integer null,
  o_zone_fo_percentage double precision null,
  o_zone_faceoffs integer null,
  pp_faceoff_percentage double precision null,
  pp_faceoffs integer null,
  sh_faceoff_percentage double precision null,
  sh_faceoffs integer null,
  total_faceoffs integer null,
  d_zone_fol integer null,
  d_zone_fow integer null,
  ev_fol integer null,
  ev_fow integer null,
  n_zone_fol integer null,
  n_zone_fow integer null,
  o_zone_fol integer null,
  o_zone_fow integer null,
  pp_fol integer null,
  pp_fow integer null,
  sh_fol integer null,
  sh_fow integer null,
  total_fol integer null,
  total_fow integer null,
  es_goals_against integer null,
  es_goals_for integer null,
  es_goals_for_percentage double precision null,
  es_toi_per_game double precision null,
  pp_goals_against integer null,
  pp_goals_for integer null,
  pp_toi_per_game double precision null,
  sh_goals_against integer null,
  sh_goals_for integer null,
  sh_toi_per_game double precision null,
  game_misconduct_penalties integer null,
  major_penalties integer null,
  match_penalties integer null,
  minor_penalties integer null,
  misconduct_penalties integer null,
  penalties integer null,
  penalties_drawn integer null,
  penalties_drawn_per_60 double precision null,
  penalties_taken_per_60 double precision null,
  penalty_minutes integer null,
  penalty_minutes_per_toi double precision null,
  penalty_seconds_per_game double precision null,
  pp_goals_against_per_60 double precision null,
  sh_assists integer null,
  sh_goals integer null,
  sh_points integer null,
  sh_goals_per_60 double precision null,
  sh_individual_sat_for integer null,
  sh_individual_sat_per_60 double precision null,
  sh_points_per_60 double precision null,
  sh_primary_assists integer null,
  sh_primary_assists_per_60 double precision null,
  sh_secondary_assists integer null,
  sh_secondary_assists_per_60 double precision null,
  sh_shooting_percentage double precision null,
  sh_shots integer null,
  sh_shots_per_60 double precision null,
  sh_time_on_ice integer null,
  sh_time_on_ice_pct_per_game double precision null,
  pp_assists integer null,
  pp_goals integer null,
  pp_goals_for_per_60 double precision null,
  pp_goals_per_60 double precision null,
  pp_individual_sat_for integer null,
  pp_individual_sat_per_60 double precision null,
  pp_points_per_60 double precision null,
  pp_primary_assists integer null,
  pp_primary_assists_per_60 double precision null,
  pp_secondary_assists integer null,
  pp_secondary_assists_per_60 double precision null,
  pp_shooting_percentage double precision null,
  pp_shots integer null,
  pp_shots_per_60 double precision null,
  pp_toi integer null,
  pp_toi_pct_per_game double precision null,
  goals_pct double precision null,
  faceoff_pct_5v5 double precision null,
  individual_sat_for_per_60 double precision null,
  individual_shots_for_per_60 double precision null,
  on_ice_shooting_pct double precision null,
  sat_pct double precision null,
  toi_per_game_5v5 double precision null,
  usat_pct double precision null,
  zone_start_pct double precision null,
  sat_against integer null,
  sat_ahead integer null,
  sat_behind integer null,
  sat_close integer null,
  sat_for integer null,
  sat_tied integer null,
  sat_total integer null,
  usat_against integer null,
  usat_ahead integer null,
  usat_behind integer null,
  usat_close integer null,
  usat_for integer null,
  usat_tied integer null,
  usat_total integer null,
  sat_percentage double precision null,
  sat_percentage_ahead double precision null,
  sat_percentage_behind double precision null,
  sat_percentage_close double precision null,
  sat_percentage_tied double precision null,
  sat_relative double precision null,
  shooting_percentage_5v5 double precision null,
  skater_save_pct_5v5 double precision null,
  skater_shooting_plus_save_pct_5v5 double precision null,
  usat_percentage double precision null,
  usat_percentage_ahead double precision null,
  usat_percentage_behind double precision null,
  usat_percentage_close double precision null,
  usat_percentage_tied double precision null,
  usat_relative double precision null,
  zone_start_pct_5v5 double precision null,
  assists_5v5 integer null,
  assists_per_60_5v5 double precision null,
  goals_5v5 integer null,
  goals_per_60_5v5 double precision null,
  o_zone_start_pct_5v5 double precision null,
  on_ice_shooting_pct_5v5 double precision null,
  points_5v5 integer null,
  points_per_60_5v5 double precision null,
  primary_assists_5v5 integer null,
  primary_assists_per_60_5v5 double precision null,
  sat_relative_5v5 double precision null,
  secondary_assists_5v5 integer null,
  secondary_assists_per_60_5v5 double precision null,
  total_primary_assists integer null,
  total_secondary_assists integer null,
  goals_backhand integer null,
  goals_bat integer null,
  goals_between_legs integer null,
  goals_cradle integer null,
  goals_deflected integer null,
  goals_poke integer null,
  goals_slap integer null,
  goals_snap integer null,
  goals_tip_in integer null,
  goals_wrap_around integer null,
  goals_wrist integer null,
  shots_on_net_backhand integer null,
  shots_on_net_bat integer null,
  shots_on_net_between_legs integer null,
  shots_on_net_cradle integer null,
  shots_on_net_deflected integer null,
  shots_on_net_poke integer null,
  shots_on_net_slap integer null,
  shots_on_net_snap integer null,
  shots_on_net_tip_in integer null,
  shots_on_net_wrap_around integer null,
  shots_on_net_wrist integer null,
  ev_time_on_ice integer null,
  ev_time_on_ice_per_game double precision null,
  ot_time_on_ice integer null,
  ot_time_on_ice_per_game double precision null,
  shifts integer null,
  shifts_per_game double precision null,
  time_on_ice_per_shift double precision null,
  birth_city text null,
  birth_date text null,
  current_team_abbreviation text null,
  current_team_name text null,
  draft_overall integer null,
  draft_round integer null,
  draft_year integer null,
  first_season_for_game_type integer null,
  nationality_code text null,
  weight integer null,
  height integer null,
  birth_country text null,
  updated_at timestamp with time zone null,
  constraint wgo_skater_stats_totals_pkey primary key (player_id, season),
  constraint unique_player_season unique (player_id, season)
) TABLESPACE pg_default;

create unique INDEX IF not exists idx_wgo_skater_stats_totals_player_season on public.wgo_skater_stats_totals using btree (player_id, season) TABLESPACE pg_default;
```

`player_stats_unified` materialized view:
```sql 
 SELECT w.player_id,
    w.date,
    w.season_id,
    p.team_id,
    w.player_name,
    w.position_code,
    w.shoots_catches,
    w.games_played,
    w.points,
    w.goals,
    w.assists,
    w.shots,
    w.shooting_percentage,
    w.plus_minus,
    w.gw_goals,
    w.pp_points,
    w.sh_points,
    w.fow_percentage,
    w.toi_per_game,
    w.penalty_minutes,
    w.hits,
    w.blocked_shots,
    w.takeaways,
    w.giveaways,
    w.d_zone_fo_percentage,
    w.d_zone_faceoffs,
    w.ev_faceoff_percentage,
    w.ev_faceoffs,
    w.n_zone_fo_percentage,
    w.n_zone_faceoffs,
    w.o_zone_fo_percentage,
    w.o_zone_faceoffs,
    w.total_faceoffs,
    w.total_fol,
    w.total_fow,
    w.es_goals_against,
    w.es_goals_for,
    w.es_goals_for_percentage,
    w.es_toi_per_game,
    w.pp_assists,
    w.pp_goals,
    w.pp_goals_against,
    w.pp_goals_for,
    w.pp_goals_for_per_60,
    w.pp_goals_per_60,
    w.pp_individual_sat_for,
    w.pp_individual_sat_per_60,
    w.pp_points_per_60,
    w.pp_primary_assists,
    w.pp_primary_assists_per_60,
    w.pp_secondary_assists,
    w.pp_secondary_assists_per_60,
    w.pp_shooting_percentage,
    w.pp_shots,
    w.pp_shots_per_60,
    w.pp_toi,
    w.pp_toi_pct_per_game,
    w.sh_assists,
    w.sh_goals,
    w.sh_goals_per_60,
    w.sh_primary_assists,
    w.sh_primary_assists_per_60,
    w.sh_secondary_assists,
    w.sh_secondary_assists_per_60,
    w.sh_shooting_percentage,
    w.sh_shots,
    w.sh_time_on_ice,
    w.penalties,
    w.penalties_drawn,
    w.goals_pct,
    w.faceoff_pct_5v5,
    w.individual_sat_for_per_60,
    w.individual_shots_for_per_60,
    w.on_ice_shooting_pct,
    w.sat_pct,
    w.toi_per_game_5v5,
    w.zone_start_pct,
    w.shooting_percentage_5v5,
    w.skater_save_pct_5v5,
    w.skater_shooting_plus_save_pct_5v5,
    w.zone_start_pct_5v5,
    w.assists_5v5,
    w.assists_per_60_5v5,
    w.goals_5v5,
    w.goals_per_60_5v5,
    w.o_zone_start_pct_5v5,
    w.on_ice_shooting_pct_5v5,
    w.points_5v5,
    w.points_per_60_5v5,
    w.primary_assists_5v5,
    w.primary_assists_per_60_5v5,
    w.secondary_assists_5v5,
    w.secondary_assists_per_60_5v5,
    w.total_primary_assists,
    w.total_secondary_assists,
    w.ev_time_on_ice,
    w.shifts,
    w.time_on_ice_per_shift,
    w.missed_shots,
    nc.toi AS nst_toi,
    nc.first_assists AS nst_first_assists,
    nc.second_assists AS nst_second_assists,
    nc.ipp AS nst_ipp,
    nc.ixg AS nst_ixg,
    nc.icf AS nst_icf,
    nc.iff AS nst_iff,
    nc.iscfs AS nst_iscfs,
    nc.hdcf AS nst_hdcf,
    nc.rush_attempts AS nst_rush_attempts,
    nc.rebounds_created AS nst_rebounds_created,
    nc.penalties_drawn AS nst_penalties_drawn,
    nc.hits_taken AS nst_hits_taken,
    nc.faceoffs_won AS nst_faceoffs_won,
    nc.faceoffs_lost AS nst_faceoffs_lost,
    nco.cf AS nst_oi_cf,
    nco.ca AS nst_oi_ca,
    nco.cf_pct AS nst_oi_cf_pct,
    nco.ff AS nst_oi_ff,
    nco.fa AS nst_oi_fa,
    nco.ff_pct AS nst_oi_ff_pct,
    nco.sf AS nst_oi_sf,
    nco.sa AS nst_oi_sa,
    nco.sf_pct AS nst_oi_sf_pct,
    nco.gf AS nst_oi_gf,
    nco.ga AS nst_oi_ga,
    nco.gf_pct AS nst_oi_gf_pct,
    nco.xgf AS nst_oi_xgf,
    nco.xga AS nst_oi_xga,
    nco.xgf_pct AS nst_oi_xgf_pct,
    nco.scf AS nst_oi_scf,
    nco.sca AS nst_oi_sca,
    nco.scf_pct AS nst_oi_scf_pct,
    nco.hdcf AS nst_oi_hdcf,
    nco.hdca AS nst_oi_hdca,
    nco.hdcf_pct AS nst_oi_hdcf_pct,
    nco.hdgf AS nst_oi_hdgf,
    nco.hdga AS nst_oi_hdga,
    nco.hdgf_pct AS nst_oi_hdgf_pct,
    nco.mdcf AS nst_oi_mdcf,
    nco.mdca AS nst_oi_mdca,
    nco.mdcf_pct AS nst_oi_mdcf_pct,
    nco.mdgf AS nst_oi_mdgf,
    nco.mdga AS nst_oi_mdga,
    nco.mdgf_pct AS nst_oi_mdgf_pct,
    nco.ldcf AS nst_oi_ldcf,
    nco.ldca AS nst_oi_ldca,
    nco.ldgf AS nst_oi_ldgf,
    nco.ldga AS nst_oi_ldga,
    nco.on_ice_sh_pct AS nst_oi_shooting_pct,
    nco.on_ice_sv_pct AS nst_oi_save_pct,
    nco.pdo AS nst_oi_pdo,
    nco.off_zone_starts AS nst_oi_off_zone_starts,
    nco.neu_zone_starts AS nst_oi_neu_zone_starts,
    nco.def_zone_starts AS nst_oi_def_zone_starts,
    nco.off_zone_start_pct AS nst_oi_off_zone_start_pct,
    nr.goals_per_60 AS nst_goals_per_60,
    nr.total_assists_per_60 AS nst_assists_per_60,
    nr.first_assists_per_60 AS nst_first_assists_per_60,
    nr.second_assists_per_60 AS nst_second_assists_per_60,
    nr.total_points_per_60 AS nst_points_per_60,
    nr.shots_per_60 AS nst_shots_per_60,
    nr.ixg_per_60 AS nst_ixg_per_60,
    nr.icf_per_60 AS nst_icf_per_60,
    nr.iff_per_60 AS nst_iff_per_60,
    nr.iscfs_per_60 AS nst_iscfs_per_60,
    nr.hdcf_per_60 AS nst_hdcf_per_60,
    nr.rush_attempts_per_60 AS nst_rush_attempts_per_60,
    nr.rebounds_created_per_60 AS nst_rebounds_created_per_60,
    nr.pim_per_60 AS nst_pim_per_60,
    nr.penalties_drawn_per_60 AS nst_penalties_drawn_per_60,
    nr.giveaways_per_60 AS nst_giveaways_per_60,
    nr.takeaways_per_60 AS nst_takeaways_per_60,
    nr.hits_per_60 AS nst_hits_per_60,
    nr.shots_blocked_per_60 AS nst_shots_blocked_per_60,
    nr.faceoffs_won_per_60 AS nst_faceoffs_won_per_60,
    nr.faceoffs_lost_per_60 AS nst_faceoffs_lost_per_60,
    nr.hits_taken_per_60 AS nst_hits_taken_per_60,
    nro.cf_per_60 AS nst_oi_cf_per_60,
    nro.ca_per_60 AS nst_oi_ca_per_60,
    nro.cf_pct AS nst_oi_cf_pct_rates,
    nro.ff_per_60 AS nst_oi_ff_per_60,
    nro.fa_per_60 AS nst_oi_fa_per_60,
    nro.ff_pct AS nst_oi_ff_pct_rates,
    nro.sf_per_60 AS nst_oi_sf_per_60,
    nro.sa_per_60 AS nst_oi_sa_per_60,
    nro.sf_pct AS nst_oi_sf_pct_rates,
    nro.gf_per_60 AS nst_oi_gf_per_60,
    nro.ga_per_60 AS nst_oi_ga_per_60,
    nro.gf_pct AS nst_oi_gf_pct_rates,
    nro.xgf_per_60 AS nst_oi_xgf_per_60,
    nro.xga_per_60 AS nst_oi_xga_per_60,
    nro.xgf_pct AS nst_oi_xgf_pct_rates,
    nro.scf_per_60 AS nst_oi_scf_per_60,
    nro.sca_per_60 AS nst_oi_sca_per_60,
    nro.scf_pct AS nst_oi_scf_pct_rates,
    nro.hdcf_per_60 AS nst_oi_hdcf_per_60,
    nro.hdca_per_60 AS nst_oi_hdca_per_60,
    nro.hdcf_pct AS nst_oi_hdcf_pct_rates,
    nro.hdgf_per_60 AS nst_oi_hdgf_per_60,
    nro.hdga_per_60 AS nst_oi_hdga_per_60,
    nro.hdgf_pct AS nst_oi_hdgf_pct_rates,
    nro.mdcf_per_60 AS nst_oi_mdcf_per_60,
    nro.mdca_per_60 AS nst_oi_mdca_per_60,
    nro.mdcf_pct AS nst_oi_mdcf_pct_rates,
    nro.mdgf_per_60 AS nst_oi_mdgf_per_60,
    nro.mdga_per_60 AS nst_oi_mdga_per_60,
    nro.mdgf_pct AS nst_oi_mdgf_pct_rates,
    nro.ldcf_per_60 AS nst_oi_ldcf_per_60,
    nro.ldca_per_60 AS nst_oi_ldca_per_60,
    nro.ldcf_pct AS nst_oi_ldcf_pct_rates,
    nro.ldgf_per_60 AS nst_oi_ldgf_per_60,
    nro.ldga_per_60 AS nst_oi_ldga_per_60,
    nro.ldgf_pct AS nst_oi_ldgf_pct_rates,
    nro.on_ice_sh_pct AS nst_oi_sh_pct_rates,
    nro.on_ice_sv_pct AS nst_oi_sv_pct_rates,
    nro.pdo AS nst_oi_pdo_rates,
    nro.off_zone_starts_per_60 AS nst_oi_off_zone_starts_per_60,
    nro.neu_zone_starts_per_60 AS nst_oi_neu_zone_starts_per_60,
    nro.def_zone_starts_per_60 AS nst_oi_def_zone_starts_per_60,
    nro.off_zone_start_pct AS nst_oi_off_zone_start_pct_rates,
        CASE
            WHEN nc.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_counts,
        CASE
            WHEN nco.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_counts_oi,
        CASE
            WHEN nr.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_rates,
        CASE
            WHEN nro.player_id IS NOT NULL THEN true
            ELSE false
        END AS has_nst_rates_oi,
    COALESCE(w.shots, 0) AS shots_safe,
    COALESCE(w.shooting_percentage, 0::double precision) AS shooting_pct_safe,
    COALESCE(nco.cf_pct, 0.5::double precision) AS possession_pct_safe,
    CURRENT_TIMESTAMP AS materialized_at
   FROM wgo_skater_stats w
     LEFT JOIN players p ON w.player_id = p.id
     LEFT JOIN nst_gamelog_as_counts nc ON w.player_id = nc.player_id AND w.date = nc.date_scraped AND w.season_id = nc.season
     LEFT JOIN nst_gamelog_as_counts_oi nco ON w.player_id = nco.player_id AND w.date = nco.date_scraped AND w.season_id = nco.season
     LEFT JOIN nst_gamelog_as_rates nr ON w.player_id = nr.player_id AND w.date = nr.date_scraped AND w.season_id = nr.season
     LEFT JOIN nst_gamelog_as_rates_oi nro ON w.player_id = nro.player_id AND w.date = nro.date_scraped AND w.season_id = nro.season
  WHERE w.games_played = 1 AND w.date >= '2023-01-01'::date AND w.player_id IS NOT NULL AND w.date IS NOT NULL
  ORDER BY w.player_id, w.date;
  ```

  `player_totals_unified` materialized view:
  ```sql
   WITH game_data AS (
         SELECT w.player_id,
            w.season_id,
            p.team_id,
            w.player_name,
            w.position_code,
            w.shoots_catches,
            w.date,
            w.games_played,
            w.points,
            w.goals,
            w.assists,
            w.shots,
            w.plus_minus,
            w.gw_goals,
            w.pp_points,
            w.sh_points,
            w.penalty_minutes,
            w.hits,
            w.blocked_shots,
            w.takeaways,
            w.giveaways,
            w.d_zone_faceoffs,
            w.ev_faceoffs,
            w.n_zone_faceoffs,
            w.o_zone_faceoffs,
            w.total_faceoffs,
            w.total_fol,
            w.total_fow,
            w.es_goals_against,
            w.es_goals_for,
            w.pp_assists,
            w.pp_goals,
            w.pp_goals_against,
            w.pp_goals_for,
            w.pp_individual_sat_for,
            w.pp_primary_assists,
            w.pp_secondary_assists,
            w.pp_shots,
            w.sh_assists,
            w.sh_goals,
            w.sh_primary_assists,
            w.sh_secondary_assists,
            w.sh_shots,
            w.penalties,
            w.penalties_drawn,
            w.assists_5v5,
            w.goals_5v5,
            w.points_5v5,
            w.primary_assists_5v5,
            w.secondary_assists_5v5,
            w.total_primary_assists,
            w.total_secondary_assists,
            w.shifts,
            w.missed_shots,
            w.toi_per_game,
            w.es_toi_per_game,
            w.pp_toi,
            w.sh_time_on_ice,
            w.ev_time_on_ice,
            w.toi_per_game_5v5,
            nc.toi AS nst_toi,
            nc.first_assists AS nst_first_assists,
            nc.second_assists AS nst_second_assists,
            nc.ixg AS nst_ixg,
            nc.icf AS nst_icf,
            nc.iff AS nst_iff,
            nc.iscfs AS nst_iscfs,
            nc.hdcf AS nst_hdcf,
            nc.rush_attempts AS nst_rush_attempts,
            nc.rebounds_created AS nst_rebounds_created,
            nc.penalties_drawn AS nst_penalties_drawn,
            nc.hits_taken AS nst_hits_taken,
            nc.faceoffs_won AS nst_faceoffs_won,
            nc.faceoffs_lost AS nst_faceoffs_lost,
            nco.cf AS nst_oi_cf,
            nco.ca AS nst_oi_ca,
            nco.ff AS nst_oi_ff,
            nco.fa AS nst_oi_fa,
            nco.sf AS nst_oi_sf,
            nco.sa AS nst_oi_sa,
            nco.gf AS nst_oi_gf,
            nco.ga AS nst_oi_ga,
            nco.xgf AS nst_oi_xgf,
            nco.xga AS nst_oi_xga,
            nco.scf AS nst_oi_scf,
            nco.sca AS nst_oi_sca,
            nco.hdcf AS nst_oi_hdcf,
            nco.hdca AS nst_oi_hdca,
            nco.hdgf AS nst_oi_hdgf,
            nco.hdga AS nst_oi_hdga,
            nco.mdcf AS nst_oi_mdcf,
            nco.mdca AS nst_oi_mdca,
            nco.mdgf AS nst_oi_mdgf,
            nco.mdga AS nst_oi_mdga,
            nco.ldcf AS nst_oi_ldcf,
            nco.ldca AS nst_oi_ldca,
            nco.ldgf AS nst_oi_ldgf,
            nco.ldga AS nst_oi_ldga,
            nco.off_zone_starts AS nst_oi_off_zone_starts,
            nco.neu_zone_starts AS nst_oi_neu_zone_starts,
            nco.def_zone_starts AS nst_oi_def_zone_starts,
            w.d_zone_faceoffs::double precision * w.d_zone_fo_percentage AS d_zone_fow,
            w.ev_faceoffs::double precision * w.ev_faceoff_percentage AS ev_fow,
            w.n_zone_faceoffs::double precision * w.n_zone_fo_percentage AS n_zone_fow,
            w.o_zone_faceoffs::double precision * w.o_zone_fo_percentage AS o_zone_fow,
            w.pp_toi::double precision / NULLIF(w.pp_toi_pct_per_game, 0::double precision) AS team_pp_toi,
            nc.player_id IS NOT NULL AS has_nst_counts,
            nco.player_id IS NOT NULL AS has_nst_counts_oi,
            nr.player_id IS NOT NULL AS has_nst_rates,
            nro.player_id IS NOT NULL AS has_nst_rates_oi
           FROM wgo_skater_stats w
             LEFT JOIN players p ON w.player_id = p.id
             LEFT JOIN nst_gamelog_as_counts nc ON w.player_id = nc.player_id AND w.date = nc.date_scraped AND w.season_id = nc.season
             LEFT JOIN nst_gamelog_as_counts_oi nco ON w.player_id = nco.player_id AND w.date = nco.date_scraped AND w.season_id = nco.season
             LEFT JOIN nst_gamelog_as_rates nr ON w.player_id = nr.player_id AND w.date = nr.date_scraped AND w.season_id = nr.season
             LEFT JOIN nst_gamelog_as_rates_oi nro ON w.player_id = nro.player_id AND w.date = nro.date_scraped AND w.season_id = nro.season
          WHERE w.games_played = 1 AND w.date >= '2023-01-01'::date AND w.player_id IS NOT NULL AND w.date IS NOT NULL
        )
 SELECT agg.player_id,
    agg.season_id,
    max(agg.player_name) AS player_name,
    array_agg(DISTINCT agg.team_id) AS team_ids,
    max(agg.position_code) AS position_code,
    max(agg.shoots_catches) AS shoots_catches,
    sum(agg.games_played) AS games_played,
    sum(agg.points) AS points_all_situations,
    sum(agg.goals) AS goals_all_situations,
    sum(agg.assists) AS assists_all_situations,
    sum(agg.shots) AS shots_all_situations,
    sum(agg.plus_minus) AS plus_minus,
    sum(agg.gw_goals) AS gw_goals,
    sum(agg.pp_points) AS pp_points,
    sum(agg.sh_points) AS sh_points,
    sum(agg.penalty_minutes) AS penalty_minutes,
    sum(agg.hits) AS hits,
    sum(agg.blocked_shots) AS blocked_shots,
    sum(agg.takeaways) AS takeaways,
    sum(agg.giveaways) AS giveaways,
    sum(agg.total_faceoffs) AS total_faceoffs,
    sum(agg.total_fol) AS total_fol,
    sum(agg.total_fow) AS total_fow,
    sum(agg.es_goals_against) AS es_goals_against,
    sum(agg.es_goals_for) AS es_goals_for,
    sum(agg.pp_assists) AS pp_assists,
    sum(agg.pp_goals) AS pp_goals,
    sum(agg.sh_assists) AS sh_assists,
    sum(agg.sh_goals) AS sh_goals,
    sum(agg.penalties) AS penalties,
    sum(agg.penalties_drawn) AS penalties_drawn,
    sum(agg.shifts) AS shifts,
    sum(agg.missed_shots) AS missed_shots,
    sum(agg.toi_per_game) AS toi_all_situations,
    sum(agg.ev_time_on_ice) AS toi_ev,
    sum(agg.es_toi_per_game) AS toi_es,
    sum(agg.pp_toi) AS toi_pp,
    sum(agg.sh_time_on_ice) AS toi_sh,
    sum(agg.toi_per_game_5v5) AS toi_5v5,
    sum(agg.goals)::numeric / NULLIF(sum(agg.shots), 0)::numeric AS shooting_pct_all_situations,
    sum(agg.total_fow)::numeric / NULLIF(sum(agg.total_faceoffs), 0)::numeric AS fow_pct_all_situations,
    sum(agg.d_zone_fow)::numeric / NULLIF(sum(agg.d_zone_faceoffs), 0)::numeric AS d_zone_fo_pct,
    sum(agg.ev_fow)::numeric / NULLIF(sum(agg.ev_faceoffs), 0)::numeric AS ev_faceoff_pct,
    sum(agg.n_zone_fow)::numeric / NULLIF(sum(agg.n_zone_faceoffs), 0)::numeric AS n_zone_fo_pct,
    sum(agg.o_zone_fow)::numeric / NULLIF(sum(agg.o_zone_faceoffs), 0)::numeric AS o_zone_fo_pct,
    sum(agg.es_goals_for)::numeric / NULLIF(sum(agg.es_goals_for) + sum(agg.es_goals_against), 0)::numeric AS es_gf_pct,
    sum(agg.pp_goals)::numeric / NULLIF(sum(agg.pp_shots), 0)::numeric AS pp_shooting_pct,
    sum(agg.sh_goals)::numeric / NULLIF(sum(agg.sh_shots), 0)::numeric AS sh_shooting_pct,
    sum(agg.pp_toi)::numeric::double precision / NULLIF(sum(agg.team_pp_toi), 0::double precision) AS pp_toi_pct_of_team,
    sum(agg.toi_per_game)::numeric / NULLIF(sum(agg.games_played), 0)::numeric AS avg_toi_per_game_all_situations,
    sum(agg.es_toi_per_game)::numeric / NULLIF(sum(agg.games_played), 0)::numeric AS avg_es_toi_per_game,
    sum(agg.toi_per_game)::numeric / NULLIF(sum(agg.shifts), 0)::numeric AS avg_toi_per_shift,
    sum(agg.pp_goals_for)::numeric * 3600.0 / NULLIF(sum(agg.pp_toi), 0)::numeric AS pp_gf_per_60,
    sum(agg.pp_goals)::numeric * 3600.0 / NULLIF(sum(agg.pp_toi), 0)::numeric AS pp_g_per_60,
    sum(agg.pp_points)::numeric * 3600.0 / NULLIF(sum(agg.pp_toi), 0)::numeric AS pp_p_per_60,
    sum(agg.pp_shots)::numeric * 3600.0 / NULLIF(sum(agg.pp_toi), 0)::numeric AS pp_s_per_60,
    sum(agg.sh_goals)::numeric * 3600.0 / NULLIF(sum(agg.sh_time_on_ice), 0)::numeric AS sh_g_per_60,
    (sum(agg.goals_5v5)::numeric * 3600.0)::double precision / NULLIF(sum(agg.toi_per_game_5v5), 0::double precision) AS g_per_60_5v5,
    (sum(agg.assists_5v5)::numeric * 3600.0)::double precision / NULLIF(sum(agg.toi_per_game_5v5), 0::double precision) AS a_per_60_5v5,
    (sum(agg.points_5v5)::numeric * 3600.0)::double precision / NULLIF(sum(agg.toi_per_game_5v5), 0::double precision) AS p_per_60_5v5,
    sum(agg.nst_toi) AS nst_toi_all_situations,
    sum(agg.nst_ixg) AS nst_ixg_all_situations,
    sum(agg.nst_icf) AS nst_icf_all_situations,
    sum(agg.nst_iff) AS nst_iff_all_situations,
    sum(agg.nst_iscfs) AS nst_iscfs_all_situations,
    sum(agg.nst_hdcf) AS nst_hdcf_all_situations,
    sum(agg.nst_rush_attempts) AS nst_rush_attempts_all_situations,
    sum(agg.nst_rebounds_created) AS nst_rebounds_created_all_situations,
    sum(agg.nst_penalties_drawn) AS nst_penalties_drawn_all_situations,
    sum(agg.nst_hits_taken) AS nst_hits_taken_all_situations,
    sum(agg.nst_faceoffs_won) AS nst_faceoffs_won_all_situations,
    sum(agg.nst_faceoffs_lost) AS nst_faceoffs_lost_all_situations,
    sum(agg.nst_oi_cf) AS nst_oi_cf_5v5,
    sum(agg.nst_oi_ca) AS nst_oi_ca_5v5,
    sum(agg.nst_oi_ff) AS nst_oi_ff_5v5,
    sum(agg.nst_oi_fa) AS nst_oi_fa_5v5,
    sum(agg.nst_oi_sf) AS nst_oi_sf_5v5,
    sum(agg.nst_oi_sa) AS nst_oi_sa_5v5,
    sum(agg.nst_oi_gf) AS nst_oi_gf_5v5,
    sum(agg.nst_oi_ga) AS nst_oi_ga_5v5,
    sum(agg.nst_oi_xgf) AS nst_oi_xgf_5v5,
    sum(agg.nst_oi_xga) AS nst_oi_xga_5v5,
    sum(agg.nst_oi_scf) AS nst_oi_scf_5v5,
    sum(agg.nst_oi_sca) AS nst_oi_sca_5v5,
    sum(agg.nst_oi_hdcf) AS nst_oi_hdcf_5v5,
    sum(agg.nst_oi_hdca) AS nst_oi_hdca_5v5,
    sum(agg.nst_oi_hdgf) AS nst_oi_hdgf_5v5,
    sum(agg.nst_oi_hdga) AS nst_oi_hdga_5v5,
    sum(agg.nst_oi_off_zone_starts) AS nst_oi_off_zone_starts_5v5,
    sum(agg.nst_oi_neu_zone_starts) AS nst_oi_neu_zone_starts_5v5,
    sum(agg.nst_oi_def_zone_starts) AS nst_oi_def_zone_starts_5v5,
    (sum(agg.goals) + sum(agg.nst_first_assists) + sum(agg.nst_second_assists))::numeric / NULLIF(sum(agg.nst_oi_gf), 0)::numeric AS nst_ipp_all,
    sum(agg.nst_oi_cf)::numeric / NULLIF(sum(agg.nst_oi_cf) + sum(agg.nst_oi_ca), 0)::numeric AS nst_oi_cf_pct_all,
    sum(agg.nst_oi_ff)::numeric / NULLIF(sum(agg.nst_oi_ff) + sum(agg.nst_oi_fa), 0)::numeric AS nst_oi_ff_pct_all,
    sum(agg.nst_oi_sf)::numeric / NULLIF(sum(agg.nst_oi_sf) + sum(agg.nst_oi_sa), 0)::numeric AS nst_oi_sf_pct_all,
    sum(agg.nst_oi_gf)::numeric / NULLIF(sum(agg.nst_oi_gf) + sum(agg.nst_oi_ga), 0)::numeric AS nst_oi_gf_pct_all,
    sum(agg.nst_oi_xgf)::numeric::double precision / NULLIF(sum(agg.nst_oi_xgf) + sum(agg.nst_oi_xga), 0::double precision) AS nst_oi_xgf_pct_all,
    sum(agg.nst_oi_scf)::numeric / NULLIF(sum(agg.nst_oi_scf) + sum(agg.nst_oi_sca), 0)::numeric AS nst_oi_scf_pct_all,
    sum(agg.nst_oi_hdcf)::numeric / NULLIF(sum(agg.nst_oi_hdcf) + sum(agg.nst_oi_hdca), 0)::numeric AS nst_oi_hdcf_pct_all,
    sum(agg.nst_oi_hdgf)::numeric::double precision / NULLIF(sum(agg.nst_oi_hdgf)::double precision + sum(agg.nst_oi_hdga), 0::double precision) AS nst_oi_hdgf_pct_all,
    sum(agg.nst_oi_mdcf)::numeric / NULLIF(sum(agg.nst_oi_mdcf) + sum(agg.nst_oi_mdca), 0)::numeric AS nst_oi_mdcf_pct_all,
    sum(agg.nst_oi_mdgf)::numeric / NULLIF(sum(agg.nst_oi_mdgf) + sum(agg.nst_oi_mdga), 0)::numeric AS nst_oi_mdgf_pct_all,
    sum(agg.nst_oi_gf)::numeric / NULLIF(sum(agg.nst_oi_sf), 0)::numeric AS nst_oi_shooting_pct_all,
    (sum(agg.nst_oi_sa) - sum(agg.nst_oi_ga))::numeric / NULLIF(sum(agg.nst_oi_sa), 0)::numeric AS nst_oi_save_pct_all,
    sum(agg.nst_oi_gf)::numeric / NULLIF(sum(agg.nst_oi_sf), 0)::numeric + (sum(agg.nst_oi_sa) - sum(agg.nst_oi_ga))::numeric / NULLIF(sum(agg.nst_oi_sa), 0)::numeric AS nst_oi_pdo_all,
    sum(agg.nst_oi_off_zone_starts)::numeric / NULLIF(sum(agg.nst_oi_off_zone_starts) + sum(agg.nst_oi_def_zone_starts), 0)::numeric AS nst_oi_off_zone_start_pct_all,
    sum(agg.goals)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_g_per_60_all_situations,
    sum(agg.nst_first_assists + agg.nst_second_assists)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_a_per_60_all_situations,
    sum(agg.goals + agg.nst_first_assists + agg.nst_second_assists)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_p_per_60_all_situations,
    sum(agg.shots)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_s_per_60_all_situations,
    sum(agg.nst_ixg) * 3600.0::double precision / NULLIF(sum(agg.nst_toi), 0)::double precision AS nst_ixg_per_60_all_situations,
    sum(agg.nst_icf)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_icf_per_60_all_situations,
    sum(agg.nst_iff)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_iff_per_60_all_situations,
    sum(agg.nst_iscfs)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_iscfs_per_60_all_situations,
    sum(agg.nst_hdcf)::numeric * 3600.0 / NULLIF(sum(agg.nst_toi), 0)::numeric AS nst_hdcf_per_60_all_situations,
    bool_or(agg.has_nst_counts) AS has_nst_counts,
    bool_or(agg.has_nst_counts_oi) AS has_nst_counts_oi,
    bool_or(agg.has_nst_rates) AS has_nst_rates,
    bool_or(agg.has_nst_rates_oi) AS has_nst_rates_oi,
    CURRENT_TIMESTAMP AS materialized_at
   FROM game_data agg
  GROUP BY agg.player_id, agg.season_id;
  ```

  